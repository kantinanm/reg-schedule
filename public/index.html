<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>

    <!-- jQuery Datepicker -->
    <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/smoothness/jquery-ui.css" rel="stylesheet"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link href="https://fonts.googleapis.com/css?family=Mali" rel="stylesheet">

    <!-- myscript -->
    <script src="/public/js/script.js"></script>

    <title>ระบบจองห้องเรียนออนไลน์</title>
    <style>
      body{
        font-family: 'Mali', cursive;
      }
    </style>
  </head>
  <body>
      <div class="container-fluid">
        <nav class="navbar navbar-light bg-light">
          <a class="navbar-brand" href="#">
            <i class="material-icons">computer</i>
            ระบบจองห้องเรียนออนไลน์
          </a>
          <div class="form-inline my-2 my-lg-0">
            <input class="form-control mr-sm-2" type="text" placeholder="Username" name="txtUsr" id="txtUsr" />
            <input class="form-control mr-sm-2" type="password" placeholder="Password" name="txtPwd" id="txtPwd" />
            <button class="btn btn-outline-secondary my-2 my-sm-0" id="cmdSummit">เข้าสู่ระบบ</button>
          </div>
        </nav>
        <div class="row">
        </div>
        <div class="row">
          <div class="col-sm">
            <div class="card">
              <div class="card-header">ค้นหาข้อมูลจากห้อง</div>
              <div class="card-body">
                <form>
                  <div class="form-row">
                    <div class="form-group col-md-2">
                      <label for="cboBuilding">อาคารเรียน</label>
                      <select id="cboBuilding" class="form-control">
                        <option selected>Choose...</option>
                        <option value="EE">EE</option>
                        <option value="EN">EN</option>
                        <option value="CE">CE</option>
                        <option value="IE">IE</option>
                      </select>
                    </div>
                    <div class="form-group col-md-2">
                      <label for="cboRoom">ห้องเรียน</label>
                      <select id="cboRoom" class="form-control">
                        <option selected>Choose...</option>
                      </select>
                    </div>
                    <div class="form-group col-md-2">
                      <label for="mydate">วันที่</label>
                      <input class="form-control" id="mydate">
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
            <div class="col-sm">
              <div class="card">
                <div class="card-header">ตารางการใช้ห้องเรียน</div>
                <div class="card-body">
                  <div id="tableDiv">
                  </div>
                </div>
              </div>
            </div>
          </div>
      </div>

    <script>
      var serverTime;
      var bookRoom;
      $.getJSON("/time", function (data) {
        serverTime = data;
        var d = new Date(serverTime);
        var n = d.getDay();
        let dates = {
          start: new Date(serverTime).setDate(d.getDate()-n),
          end: new Date(serverTime).setDate(d.getDate()+6-n),
        };
        $.post("/bookroom", dates, function (result) {
          if (result) {
            bookRoom=result;
          } else {
            alert('Invalid');
          }
        });
      });

      $(document).ready(function(){
         $("#mydate").datepicker({
           changeYear: true,
           changeMonth: true,
           dateFormat: "dd/m/yy",
           yearRange: "-100:+20",
         });
      });

      $("#cmdSummit").click(function () {
        var form = {
          txtUsr: $("#txtUsr").val(),
          txtPwd: $("#txtPwd").val()
        }
        $.post("/login", form, function (result) {
          if (result) {
            sessionStorage.setItem('user', JSON.stringify(result));
            window.location.href = '/public/schedule.html';
          } else {
            alert('Invalid user or password')
          }
        });
      });

      $( "#cboBuilding" ).change(function() {
        /* --------------- เมื่อมีการเลือกอาคารเรียน ให้ loop แสดงห้องทั้งหมดในอาคาร ------------------*/
        $("#cboRoom option").remove();
        $("#cboRoom").append('<option selected>Choose...</option>');
        $.getJSON( "/building/"+$("#cboBuilding").val(), function( data ) {
          if($("#cboBuilding").val() === "EE"){ //ถ้า cboBuilding เท่ากับ EE ให้เพิ่มห้อง EE 315
            $('#cboRoom')
            .append($("<option></option>")
              .attr("value","0000")
              .text("EE 315"));
          }
          $.each(data, function(key, value) {
            var result = value.title.split('ความจุ : ');
            var text = value.title.split(' ประเภท');
            if(result[1].substring(0,1) != 0){
              $('#cboRoom')
              .append($("<option></option>")
                .attr("value",value.room_id)
                .text(text[0]));
            }
          });
        });
      });

      $( "#mydate" ).change(function(){
        /* --------------- เมื่อเลือกวันที่ในการค้นหาแบบห้องเรียน ------------------*/
        if($("#cboBuilding").val()=="Choose..."){
          alert("กรุณาเลือกอาคารเรียนและห้องเรียนก่อนด้วยค่ะ");
        }else{
          $.getJSON( "/room", function( data ) {
            var myschedule = getSchedule(data,"room");
            myschedule.sort(function(a,b){  //เรียงเวลาใน json ใหม่จากน้อยไปมาก
               if(a.start > b.start){ return 1}
                if(a.start < b.start){ return -1}
                  return 0;
            });
            var myTable = getTable(myschedule,$( "#mydate" ).val());
            $('#tableDiv').html(myTable);
          });
        }
      });

      $( "#cboRoom" ).change(function() {
        /* --------------- เมื่อ cboRoom มีการเปลี่ยนแปลงจากการค้นหาแบบห้องเรียน ------------------*/
        if($("#mydate").val()!=""){
          $.getJSON( "/room", function( data ) {
            var myschedule = getSchedule(data,"room");
            myschedule.sort(function(a,b){  //เรียงเวลาใน json ใหม่จากน้อยไปมาก
               if(a.start > b.start){ return 1}
                if(a.start < b.start){ return -1}
                  return 0;
            });
            var myTable = getTable(myschedule,$( "#mydate" ).val());
            $('#tableDiv').html(myTable);
          });
        }else{
          $.getJSON( "/room", function( data ) {
            var myschedule = getSchedule(data,"room");
            myschedule.sort(function(a,b){  //เรียงเวลาใน json ใหม่จากน้อยไปมาก
               if(a.start > b.start){ return 1}
                if(a.start < b.start){ return -1}
                  return 0;
            });
            var myTable = getTable(myschedule,null);
            $('#tableDiv').html(myTable);
          });
        }
      });
    </script>
  </body>
</html>
