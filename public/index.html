<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link href="https://fonts.googleapis.com/css?family=Mali" rel="stylesheet">
    <title>ระบบจองห้องเรียนออนไลน์</title>
    <style>
      body{
        font-family: 'Mali', cursive;
      }
    </style>
  </head>
  <body>
      <div class="container-fluid">
        <nav class="navbar navbar-light bg-light">
          <a class="navbar-brand" href="#">
            <i class="material-icons">computer</i>
            ระบบจองห้องเรียนออนไลน์
          </a>
        </nav>
        <div class="row">
        </div>
        <div class="row">
          <div class="col-sm">
            <div class="card">
              <div class="card-header">
                ค้นหาข้อมูล
              </div>
              <div class="card-body">
                <form>
                  <div class="form-row">
                    <div class="form-group col-md-2">
                      <label for="cboBuilding">อาคารเรียน</label>
                      <select id="cboBuilding" class="form-control">
                        <option selected>Choose...</option>
                        <option value="EE">EE</option>
                        <option value="EN">EN</option>
                        <option value="CE">CE</option>
                        <option value="IE">IE</option>
                      </select>
                    </div>
                    <div class="form-group col-md-2">
                      <label for="cboRoom">ห้องเรียน</label>
                      <select id="cboRoom" class="form-control">
                        <option selected>Choose...</option>
                      </select>
                    </div>
                    <div class="form-group col-md-2">
                      <label for="cboRoom">วันที่</label>
                      <input type="date" class="form-control"></input>
                    </div>
                  </div>
                  <!--<button type="submit" class="btn btn-secondary">ค้นหา</button>-->
                </form>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
            <div class="col-sm">
              <div class="card">
                <div class="card-header">
                  ตารางการใช้ห้องเรียน
                </div>
                <div class="card-body">
                    <div id="tableDiv">
                    </div>
                </div>
              </div>
            </div>
          </div>
      </div>

    <script>
      $(document).ready(function(){
        var fullDate = new Date();
        var month = fullDate.getMonth()+1;
        var day = fullDate.getDate();
        var year = fullDate.getFullYear();
        var datenow = day+"/"+month+"/"+year;
        var DateStr = fullDate.toString();
        //console.log(DateStr.substring(0,3));
        console.log(datenow);
      });
      $( "#cboBuilding" ).change(function() {
        $("#cboRoom option").remove();
        $("#cboRoom").append('<option selected>Choose...</option>');
        $.getJSON( "http://localhost:3000/building/"+$("#cboBuilding").val(), function( data ) {
          $.each(data, function(key, value) {
            var result = value.title.split('ความจุ : ');
            var text = value.title.split(' ประเภท');
            if(result[1].substring(0,1) != 0){
              $('#cboRoom')
              .append($("<option></option>")
                .attr("value",value.room_id)
                .text(text[0]));
            }
          });
        });
      });

      $( "#cboRoom" ).change(function() {
            var response = [{
              "time":"08:00-09:00"},{"time":"09:00-10:00"},{"time":"10:00-11:00"},{
              "time":"11:00-12:00"},{"time":"12:00-13:00"},{"time":"13:00-14:00"},{
              "time":"14:00-15:00"},{"time":"15:00-16:00"},{"time":"16:00-17:00"},{
              "time":"17:00-18:00"},{"time":"18:00-19:00"},{"time":"19:00-20:00"},{
              "time":"20:00-21:00"
            }];
            var dates = [{
              "in_date":"อาทิตย์"},{"in_date":"จันทร์"},{
              "in_date":"อังคาร"},{"in_date":"พุธ"},{
              "in_date":"พฤหัสบดี"},{"in_date":"ศุกร์"},{
              "in_date":"เสาร์"
            }];
          $.getJSON( "http://localhost:3000/schedule2/"+$("#cboBuilding").val()+"/"+$("#cboRoom").val()+"/2561/1", function( data ) {
          var temp = [];
          var chk=0;
          $.each(data, function(key, value) {
            $.each(value, function(key, val) {
              if($("#cboRoom option:selected").text()==val.room){
                var in_time = val.start.split('-');
                var on_time = in_time[0].replace(":","");
                var to_time = in_time[1].replace(":","");
                var all_time=parseInt(to_time)+50;
                var span=(all_time-parseInt(on_time))/100;
                var index="";
                if(in_time[0]=="08:00"){ index=0;
                }else if(in_time[0]=="09:00"){ index=1;
                }else if(in_time[0]=="10:00"){ index=2;
                }else if(in_time[0]=="11:00"){ index=3;
                }else if(in_time[0]=="12:00"){ index=4;
                }else if(in_time[0]=="13:00"){ index=5;
                }else if(in_time[0]=="14:00"){ index=6;
                }else if(in_time[0]=="15:00"){ index=7;
                }else if(in_time[0]=="16:00"){ index=8;
                }else if(in_time[0]=="17:00"){ index=9;
                }else if(in_time[0]=="18:00"){ index=10;
                }else if(in_time[0]=="19:00"){ index=11;
                }else {index=12;}
                temp.push({v:parseInt(on_time), eng:val.eng, thai:val.thai, code:val.code, date: val.date, start:val.start, room:val.room, span:span.toString(), col:index});
              }
            });
          });
          temp.sort(function(a,b){
             if(a.v > b.v){ return 1}
              if(a.v < b.v){ return -1}
                return 0;
          });
          var table_body = '<table class="table table-bordered" id="example"><thead>';
              table_body+='<tr><th>Date/Time</th>';
              $.each(response, function(key, getTime) {
                table_body +='<th>';
                table_body +=getTime.time;
                table_body +='</th>';
              });
                table_body+='</tr></thead><tbody>';
              $.each(dates, function(key, getDate) {
                table_body +='<tr>';
                table_body +='<th>';
                table_body +=getDate.in_date;
                table_body +='</th>';
                for(var i=chk;i<13;i++){
                  $.each(temp, function(key, val) {
                    if($("#cboRoom option:selected").text()==val.room){
                      if(val.date==getDate.in_date){
                        if(i==val.col){
                          chk=val.col+parseInt(val.span);
                          table_body +='<td class="bg-info text-white text-center" colspan="'+val.span+'">';
                          table_body +='<i class="material-icons" title='+val.code+'>local_offer</i>Have Class';
                          table_body +='</td>';
                          return false;
                        }
                      }
                    }
                  });
                  if(i>=chk){
                    table_body +='<td>';
                    table_body +='';
                    table_body +='</td>';
                  }
                }
                chk=0;
                table_body +='</tr>';
              });
              table_body+='</tbody>';
            $('#tableDiv').html(table_body);

            //console.log(temp);
            /*$.each(data, function(key, value) {
              $.each(value, function(key, val) {
                if($("#cboRoom option:selected").text()==val.room){
                  console.log(val.date+" "+val.code+" "+val.start);
                }
              });
            });*/
        });
      });
    </script>
  </body>
</html>
